generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   Int            @id @default(autoincrement())
  email                String         @unique
  passwordHash         String
  name                 String
  role                 Role           @default(USER)
  preferredLanguage    String         @default("ro") // Preferred locale: en, ro, fr, de, es
  tokenVersion         Int            @default(0) // Incremented to invalidate all tokens
  failedLoginAttempts  Int            @default(0) // Track failed login attempts
  lockedUntil          DateTime?      // Account locked until this time (null = not locked)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  refreshTokens        RefreshToken[]
  auditLogs            AuditLog[]
  orders               Order[]
}

// Refresh token storage for revocation support
model RefreshToken {
  id        String   @id @default(uuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   // SHA-256 hash of the token (never store plain tokens)
  expiresAt DateTime
  revokedAt DateTime? // Null if active, timestamp if revoked
  createdAt DateTime @default(now())
  userAgent String?  // Optional: track device/browser
  ipAddress String?  // Optional: track IP for security audit

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  // Composite indexes for common queries
  @@index([userId, revokedAt]) // Find valid tokens for a user
  @@index([tokenHash, revokedAt, expiresAt]) // Token validation lookup
}

enum Role {
  USER
  ADMIN
}

enum Gender {
  Men
  Women
  Unisex
}

enum Concentration {
  Eau_de_Cologne
  Eau_de_Toilette
  Eau_de_Parfum
  Parfum
  Extrait_de_Parfum
}

// Lookup tables for filter options
model FragranceFamily {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  products Product[]
}

model Longevity {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  sortOrder Int      @default(0)
  products Product[]
}

model Sillage {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  sortOrder Int      @default(0)
  products Product[]
}

model Season {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  products Product[] @relation("ProductSeasons")
}

model Occasion {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  products Product[] @relation("ProductOccasions")
}

model Product {
  id                Int             @id @default(autoincrement())
  slug              String          @unique
  name              String
  brand             String
  concentration     Concentration
  gender            Gender
  fragranceFamilyId Int
  fragranceFamily   FragranceFamily @relation(fields: [fragranceFamilyId], references: [id], onDelete: Restrict)
  topNotes          String[]
  heartNotes        String[]
  baseNotes         String[]
  volumeMl          Int
  priceRON          Decimal         @db.Decimal(10, 2)
  launchYear        Int
  perfumer          String?
  longevityId       Int
  longevity         Longevity       @relation(fields: [longevityId], references: [id], onDelete: Restrict)
  sillageId         Int
  sillage           Sillage         @relation(fields: [sillageId], references: [id], onDelete: Restrict)
  seasons           Season[]        @relation("ProductSeasons")
  occasions         Occasion[]      @relation("ProductOccasions")
  rating            Decimal         @db.Decimal(2, 1)
  stock             Int             @default(0)
  imageUrl          String?
  description       String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  deletedAt         DateTime?       // Soft delete - null means active, timestamp means deleted

  // Indexes for filtering and sorting
  @@index([slug])
  @@index([gender])
  @@index([concentration])
  @@index([brand])
  @@index([priceRON])
  @@index([rating])
  @@index([stock])
  @@index([createdAt])
  @@index([fragranceFamilyId])
  @@index([longevityId])
  @@index([sillageId])
  @@index([deletedAt])
  // Composite indexes for common filter combinations
  @@index([deletedAt, stock]) // Active products with stock
  @@index([deletedAt, brand]) // Active products by brand
  @@index([deletedAt, gender]) // Active products by gender
  @@index([deletedAt, priceRON]) // Active products sorted by price
  @@index([deletedAt, createdAt]) // Active products sorted by date
}

// Global promotion - only one active at a time
model Promotion {
  id              Int      @id @default(autoincrement())
  name            String
  discountPercent Int      // Percentage off (e.g., 15 for 15%)
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Exchange rates from BNR (Romanian National Bank)
model ExchangeRate {
  id        Int      @id @default(autoincrement())
  currency  String   @unique // EUR, GBP, etc.
  rate      Decimal  @db.Decimal(10, 4) // Rate: 1 currency = X RON
  fetchedAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Exchange rate fee settings (singleton - only one row)
model ExchangeRateSettings {
  id            Int      @id @default(1)
  feePercent    Decimal  @db.Decimal(5, 2) @default(0) // Fee percentage (e.g., 2.00 for 2%)
  updatedAt     DateTime @updatedAt
}

// Audit log for tracking admin actions
model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     // Nullable to preserve logs when user is deleted
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, PASSWORD_CHANGE
  entityType String   // PRODUCT, PROMOTION, USER, etc.
  entityId   Int?     // ID of the affected entity (nullable for actions like login)
  oldValue   Json?    // Previous state (for updates/deletes)
  newValue   Json?    // New state (for creates/updates)
  result     String?  // Operation result: SUCCESS, FAILURE, PARTIAL
  ipAddress  String?  // IP address of the request
  userAgent  String?  // Browser/client info
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  // Composite indexes for common queries
  @@index([entityType, createdAt]) // Logs by entity type with date
  @@index([userId, createdAt]) // User's activity with date
  @@index([action, createdAt]) // Actions over time
}

// Newsletter subscribers
model NewsletterSubscriber {
  id                Int       @id @default(autoincrement())
  email             String    @unique
  preferredLanguage String    @default("ro") // Captured from site locale at subscription
  isActive          Boolean   @default(true)
  subscribedAt      DateTime  @default(now())
  unsubscribedAt    DateTime?

  @@index([isActive])
  @@index([subscribedAt])
  @@index([preferredLanguage])
}

// Campaign status for newsletter campaigns
enum CampaignStatus {
  DRAFT       // Being composed, not ready to send
  SCHEDULED   // Ready and waiting for scheduled time
  SENDING     // Currently being processed
  SENT        // Successfully completed
  FAILED      // Failed with errors
}

// Newsletter campaigns for marketing emails
model NewsletterCampaign {
  id               Int             @id @default(autoincrement())
  name             String          // Internal name for identification
  templateId       String          // Reference to email template file ID

  // Status and scheduling
  status           CampaignStatus  @default(DRAFT)
  scheduledFor     DateTime?       // When to send (null = not scheduled)

  // Results (populated after sending)
  sentAt           DateTime?       // When sending completed
  totalRecipients  Int?            // Total subscribers targeted
  sentCount        Int?            // Successfully sent
  failedCount      Int?            // Failed to send

  // Prevent duplicate sends
  sendingStartedAt DateTime?       // Lock timestamp when sending begins

  // Timestamps
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([templateId])
  @@index([createdAt])
  // Composite index for finding campaigns to send
  @@index([status, scheduledFor]) // Scheduled campaigns ready to send
}

// Order status enum
enum OrderStatus {
  PENDING     // Created, awaiting payment
  PAID        // Payment confirmed via webhook
  PROCESSING  // Being prepared for shipment
  SHIPPED     // Sent to carrier
  DELIVERED   // Received by customer
  CANCELLED   // Order cancelled
  REFUNDED    // Full refund issued
}

// Orders for checkout
model Order {
  id                    Int           @id @default(autoincrement())
  orderNumber           String        @unique  // Human-readable: ORD-YYYYMMDD-XXXX

  // Customer (guest or user)
  userId                Int?
  user                  User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  guestEmail            String?       // Required for guest checkout
  customerName          String
  customerPhone         String?
  orderLocale           String        @default("ro") // Locale at time of order (for emails/invoices)

  // Shipping address
  shippingAddressLine1  String
  shippingAddressLine2  String?
  shippingCity          String
  shippingState         String?       // County/Region
  shippingPostalCode    String
  shippingCountry       String        // ISO country code

  // Amounts (stored in RON - base currency)
  subtotalRON           Decimal       @db.Decimal(10, 2)  // Before discount
  discountRON           Decimal       @db.Decimal(10, 2)  @default(0)
  discountPercent       Int?          // Promotion discount applied
  totalRON              Decimal       @db.Decimal(10, 2)  // Final amount in RON

  // Stripe payment info
  stripeSessionId       String?       @unique
  stripePaymentIntentId String?
  paidAmountEUR         Decimal?      @db.Decimal(10, 2)  // Amount charged in EUR
  exchangeRateUsed      Decimal?      @db.Decimal(10, 4)  // BNR EUR rate at checkout
  exchangeFeePercent    Decimal?      @db.Decimal(5, 2)   // Fee % from ExchangeRateSettings

  status                OrderStatus   @default(PENDING)

  // Timestamps
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  paidAt                DateTime?

  // Relations
  items                 OrderItem[]

  @@index([userId])
  @@index([guestEmail])
  @@index([status])
  @@index([createdAt])
  @@index([orderNumber])
  @@index([stripeSessionId])
  // Composite indexes for common queries
  @@index([status, createdAt]) // Orders by status with date sorting
  @@index([userId, status]) // User's orders by status
  @@index([userId, createdAt]) // User's orders by date
}

// Order line items
model OrderItem {
  id            Int       @id @default(autoincrement())
  orderId       Int
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId     Int
  productName   String    // Snapshot at time of order
  productBrand  String    // Snapshot
  productSlug   String    // For linking back to product
  volumeMl      Int
  imageUrl      String?

  quantity      Int
  unitPriceRON  Decimal   @db.Decimal(10, 2)  // Price per unit at order time
  totalPriceRON Decimal   @db.Decimal(10, 2)  // quantity * unitPrice

  createdAt     DateTime  @default(now())

  @@index([orderId])
  @@index([productId])
}
